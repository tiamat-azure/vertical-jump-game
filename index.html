<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vertical Jump Game with Movement (p5.js)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
</head>
<body>
    <script>
        let playerX, playerY, velocity;
        let jumpCharge;
        let platforms = [];
        let currentPlatform = null;
        let gameOver = false;
        let isJumping = false;
        let isScrolling = false;

        const GRAVITY = 0.5;
        const MIN_JUMP_STRENGTH = 10;
        const MAX_JUMP_STRENGTH = 15;
        const CHARGE_RATE = 0.2;
        const MOVE_SPEED = 5;
        const FIXED_PLATFORM_HEIGHT = 100;
        const MAX_JUMP_HEIGHT = 225;
        const MIN_SPACING = 50;
        const PLATFORM_COUNT = 10;

        function setup() {
            createCanvas(400, 600);
            background(135, 206, 235); // Bleu ciel
            resetGame();
        }

        function draw() {
            if (gameOver) {
                fill(0);
                textSize(32);
                textAlign(CENTER, CENTER);
                text("Game Over\nPress 'R' to Restart", width / 2, height / 2);
                return;
            }

            background(240); // Gris clair pour le conteneur
            
            // Mouvement horizontal
            if (keyIsDown(LEFT_ARROW) && playerX > 0) playerX -= MOVE_SPEED;
            if (keyIsDown(RIGHT_ARROW) && playerX < width - 40) playerX += MOVE_SPEED;

            // Chargement du saut
            if (keyIsDown(32) && !isJumping && playerY >= 0) { // 32 = Space
                jumpCharge += CHARGE_RATE;
                if (jumpCharge > MAX_JUMP_STRENGTH) jumpCharge = MAX_JUMP_STRENGTH;
            }

            // Gravité
            if (!currentPlatform) {
                velocity -= GRAVITY;
                playerY += velocity;
                if (playerY <= 0) {
                    playerY = 0;
                    velocity = 0;
                }
            }

            // Vérifier les collisions et le défilement
            checkCollisions();

            // Recycler les plateformes
            recyclePlatforms();

            // Dessiner les plateformes
            fill(34, 139, 34); // Vert pour les plateformes
            platforms.forEach(platform => {
                rect(platform.x, height - platform.y - 20, 100, 20);
            });

            // Dessiner le joueur
            fill(255, 69, 0); // Orange pour le joueur
            rect(playerX, height - playerY - 40, 40, 40);
        }

        function keyPressed() {
            if (gameOver && keyCode === 82) { // 'R' pour redémarrer
                resetGame();
            }
            if (keyCode === 32 && playerY >= 0 && !isJumping) { // Space
                jumpCharge = MIN_JUMP_STRENGTH;
            }
        }

        function keyReleased() {
            if (keyCode === 32 && !isJumping && playerY >= 0) {
                velocity = jumpCharge;
                isJumping = true;
                currentPlatform = null;
                jumpCharge = 0;
            }
        }

        function resetGame() {
            playerX = 180;
            playerY = 0;
            velocity = 0;
            jumpCharge = 0;
            isJumping = false;
            currentPlatform = null;
            gameOver = false;
            isScrolling = false;
            platforms = [];
            for (let i = 0; i < PLATFORM_COUNT; i++) {
                const yPos = i === 0 ? 100 : platforms[i - 1].y + MIN_SPACING + Math.random() * (MAX_JUMP_HEIGHT - MIN_SPACING);
                platforms.push({
                    x: Math.random() * (width - 100),
                    y: yPos
                });
            }
        }

        function recyclePlatforms() {
            platforms.forEach(platform => {
                if (platform.y <= 0) {
                    const highestPlatform = platforms.reduce((max, p) => p.y > max.y ? p : max);
                    platform.y = highestPlatform.y + MIN_SPACING + Math.random() * (MAX_JUMP_HEIGHT - MIN_SPACING);
                    platform.x = Math.random() * (width - 100);
                }
            });
        }

        function scrollPlatforms(offset, scrollSpeed) {
            const targetYs = platforms.map(platform => Math.max(0, platform.y - offset));
            const animateAllPlatforms = () => {
                let animationComplete = true;
                platforms.forEach((platform, index) => {
                    const targetY = targetYs[index];
                    if (Math.abs(platform.y - targetY) > 1) {
                        platform.y -= scrollSpeed;
                        animationComplete = false;
                    } else {
                        platform.y = targetY;
                    }
                });
                if (currentPlatform) {
                    playerY = Math.max(0, currentPlatform.y) + 20;
                }
                if (!animationComplete) {
                    requestAnimationFrame(animateAllPlatforms);
                } else {
                    isScrolling = false;
                }
            };
            animateAllPlatforms();
        }

        function checkCollisions() {
            let landed = false;

            platforms.forEach(platform => {
                if (
                    playerX + 40 > platform.x &&
                    playerX < platform.x + 100 &&
                    playerY <= platform.y + 20 &&
                    playerY > platform.y &&
                    velocity < 0
                ) {
                    playerY = platform.y + 20;
                    velocity = 0;
                    landed = true;
                    isJumping = false;
                    currentPlatform = platform;
                }
            });

            if (landed && currentPlatform && !isScrolling && currentPlatform.y > FIXED_PLATFORM_HEIGHT) {
                const offset = currentPlatform.y - FIXED_PLATFORM_HEIGHT;
                const scrollSpeed = 2;
                isScrolling = true;
                scrollPlatforms(offset, scrollSpeed);
            }

            if (playerY <= 0 && !landed) {
                if (platforms.some(p => p.y <= 0)) {
                    gameOver = true;
                } else {
                    isJumping = false;
                    currentPlatform = null;
                }
            }

            if (playerY < -40) {
                gameOver = true;
            }

            if (currentPlatform) {
                const platX = currentPlatform.x;
                if (playerX + 40 < platX || playerX > platX + 100) {
                    currentPlatform = null;
                }
            }
        }
    </script>
</body>
</html>